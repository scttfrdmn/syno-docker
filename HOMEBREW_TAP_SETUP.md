# SynoDeploy Homebrew Tap Setup Guide

This guide walks through creating and configuring the Homebrew tap for SynoDeploy distribution.

## 🏗️ **Repository Setup**

### 1. Create Homebrew Tap Repository

```bash
# Create repository on GitHub: scttfrdmn/homebrew-tap
# Repository must be named with 'homebrew-' prefix
```

**Repository Settings:**
- **Name**: `homebrew-tap`
- **Description**: "Homebrew formulae for SynoDeploy and other tools"
- **Visibility**: Public (required for Homebrew taps)
- **Initialize**: Empty repository (Goreleaser will create the structure)

### 2. GitHub Personal Access Token

Create a Personal Access Token with permissions:
- ✅ `repo` (full repository access)
- ✅ `write:packages` (for GitHub Packages)
- ✅ `delete:packages` (for package management)

**Add to GitHub Secrets:**
```bash
# In scttfrdmn/synodeploy repository settings → Secrets and variables → Actions
Name: HOMEBREW_TAP_GITHUB_TOKEN
Value: <your-personal-access-token>
```

## 📁 **Expected Tap Structure**

After first release, the tap repository will contain:

```
homebrew-tap/
├── Formula/
│   └── synodeploy.rb       # Auto-generated by Goreleaser
├── README.md               # Manual: tap documentation
├── .github/
│   └── workflows/
│       └── tests.yml       # Optional: tap testing
└── .gitignore              # Optional: ignore patterns
```

## 🚀 **Deployment Process**

### 1. Push SynoDeploy Repository
```bash
# Add remote origin
git remote add origin https://github.com/scttfrdmn/synodeploy.git

# Push main branch and tags
git push origin main --tags

# This triggers GitHub Actions → Goreleaser → Homebrew tap update
```

### 2. Goreleaser Automation
When you push a git tag:
1. **GitHub Actions** runs the release workflow
2. **Goreleaser** builds cross-platform binaries
3. **GitHub Release** is created with assets
4. **Homebrew Formula** is auto-generated and committed to tap repo
5. **Users can install** with `brew install scttfrdmn/tap/synodeploy`

## 📋 **Generated Formula Preview**

Goreleaser will create `Formula/synodeploy.rb`:

```ruby
class Synodeploy < Formula
  desc "Deploy containers to Synology DSM 7.2+ with ease"
  homepage "https://github.com/scttfrdmn/synodeploy"
  version "0.1.1"
  license "MIT"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/scttfrdmn/synodeploy/releases/download/v0.1.1/synodeploy-Darwin-x86_64.tar.gz"
      sha256 "auto-calculated-checksum"
    end
    if Hardware::CPU.arm?
      url "https://github.com/scttfrdmn/synodeploy/releases/download/v0.1.1/synodeploy-Darwin-arm64.tar.gz"
      sha256 "auto-calculated-checksum"
    end
  end

  on_linux do
    if Hardware::CPU.intel?
      url "https://github.com/scttfrdmn/synodeploy/releases/download/v0.1.1/synodeploy-Linux-x86_64.tar.gz"
      sha256 "auto-calculated-checksum"
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/scttfrdmn/synodeploy/releases/download/v0.1.1/synodeploy-Linux-arm64.tar.gz"
      sha256 "auto-calculated-checksum"
    end
  end

  def install
    bin.install "synodeploy"
    generate_completions_from_executable(bin/"synodeploy", "completion")
  end

  test do
    system "#{bin}/synodeploy", "--version"
    system "#{bin}/synodeploy", "--help"
    output = shell_output("#{bin}/synodeploy init --help")
    assert_match "Setup connection to Synology NAS", output
  end
end
```

## 👥 **User Installation Process**

After tap is live:

```bash
# Add the tap
brew tap scttfrdmn/tap

# Install synodeploy
brew install synodeploy

# Verify installation
synodeploy --version

# Use immediately
synodeploy init your-nas.local --user your-username
```

## 🔄 **Continuous Updates**

### Automatic Updates
- **New Releases**: Push git tags → automatic formula updates
- **Version Bumps**: Goreleaser handles version and checksum updates
- **Cross-platform**: All architectures updated simultaneously

### Manual Tap Management
```bash
# Clone tap repository for manual updates if needed
git clone https://github.com/scttfrdmn/homebrew-tap.git
cd homebrew-tap

# Make manual changes to Formula/synodeploy.rb if needed
# Commit and push changes
```

## ✅ **Ready to Deploy Checklist**

- ✅ **Goreleaser Config**: Updated with modern best practices
- ✅ **GitHub Actions**: Release workflow configured
- ✅ **Binary Builds**: Cross-platform compilation working
- ✅ **Shell Completions**: Auto-generation configured
- ✅ **Test Block**: Proper formula testing included
- ✅ **License**: MIT license properly declared
- ✅ **Integration Tests**: Verified working on real hardware

## 🎯 **Next Steps**

1. **Create `homebrew-tap` repository** on GitHub
2. **Add GitHub token** to synodeploy repository secrets
3. **Push synodeploy code** to GitHub with tags
4. **Users can install** with `brew install scttfrdmn/tap/synodeploy`

The entire automation pipeline is configured and ready for deployment!

## 🔍 **Verification Commands**

After tap creation, verify with:
```bash
# Test tap installation locally
brew tap scttfrdmn/tap
brew install synodeploy

# Test functionality
synodeploy --version
synodeploy init --help

# Test on your system
synodeploy init chubchub.local --user scttfrdmn
synodeploy run hello-world --name test
synodeploy ps
synodeploy rm test --force
```